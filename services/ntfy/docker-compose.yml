version: '3.8'

services:
  ntfy:
    image: lib/ntfy:latest
    container_name: ntfy
    command: ["serve"]
    environment:
      NTFY_BASE_URL: ${NTFY_BASE_URL}
      NTFY_LISTEN_HTTP: ${NTFY_LISTEN_HTTP}
      NTFY_CACHE_FILE: ${NTFY_CACHE_FILE}
      NTFY_CACHE_DURATION: ${NTFY_CACHE_DURATION}
      NTFY_AUTH_FILE: ${NTFY_AUTH_FILE}
      NTFY_AUTH_DEFAULT_ACCESS: ${NTFY_AUTH_DEFAULT_ACCESS}
      NTFY_AUTH_USERS: ${NTFY_AUTH_USERS}
      NTFY_AUTH_ACCESS: ${NTFY_AUTH_ACCESS}
      NTFY_ENABLE_LOGIN: ${NTFY_ENABLE_LOGIN}
      NTFY_ATTACHMENT_CACHE_DIR: ${NTFY_ATTACHMENT_CACHE_DIR}
      NTFY_ATTACHMENT_TOTAL_SIZE_LIMIT: ${NTFY_ATTACHMENT_TOTAL_SIZE_LIMIT}
      NTFY_ATTACHMENT_FILE_SIZE_LIMIT: ${NTFY_ATTACHMENT_FILE_SIZE_LIMIT}
      NTFY_ATTACHMENT_EXPIRY_DURATION: ${NTFY_ATTACHMENT_EXPIRY_DURATION}
      NTFY_BEHIND_PROXY: ${NTFY_BEHIND_PROXY}
      # Email Configuration
      NTFY_SMTP_SENDER_ADDR: ${NTFY_SMTP_SENDER_ADDR}
      NTFY_SMTP_SENDER_FROM: ${NTFY_SMTP_SENDER_FROM}
      NTFY_SMTP_SENDER_USER: ${NTFY_SMTP_SENDER_USER}
      NTFY_SMTP_SENDER_PASS: ${NTFY_SMTP_SENDER_PASS}
    ports:
      - "${NTFY_PORT}:80"
    volumes:
      - ../../config/ntfy:/var/lib/ntfy
    healthcheck:
        test: ["CMD-SHELL", "wget -q --tries=1 http://localhost:80/v1/health -O - | grep -Eo '\"healthy\"\\s*:\\s*true' || exit 1"]
        interval: 60s
        timeout: 10s
        retries: 3
        start_period: 40s

    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.10'
          memory: 64M
        reservations:
          cpus: '0.05'
          memory: 32M
